<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ø¶Ùˆ - Ù†Ø§Ø¯ÙŠ Ù…Ø¯ÙŠØ³ÙŠØ³Ø©</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Cairo&display=swap');

body {
    font-family: 'Cairo', sans-serif;
    background: #f2f0ec;
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

/* ===== Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ ===== */
.top-bar{
    width:100%;
    max-width:900px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:15px;
}

.balance-box{
    background:#7a0000;
    color:#fff;
    padding:10px 15px;
    border-radius:12px;
    display:flex;
    align-items:center;
    gap:8px;
    box-shadow:0 5px 15px rgba(0,0,0,.3);
}

.balance-box span{
    font-weight:bold;
}

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø®Ø¯Ù…Ø§Øª */
.services {
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    justify-content:center;
    margin-bottom:20px;
}

.service-btn{
    padding:12px 20px;
    border:none;
    border-radius:12px;
    background:#7a0000;
    color:#fff;
    font-weight:bold;
    cursor:pointer;
    box-shadow:0 5px 15px rgba(0,0,0,.3);
    transition: all 0.3s ease;
    position: relative;
}

.service-btn span {
    font-size: 13px;
    margin-right: 6px;
    background: gold;
    padding: 2px 6px;
    border-radius: 6px;
    color:#000;
}

.service-btn:hover{
    transform: translateY(-3px) scale(1.05);
    box-shadow:0 8px 25px rgba(0,0,0,.4);
}

/* ===== Ø±ÙˆØ§Ø¨Ø· ÙˆØ£Ø²Ø±Ø§Ø± Ø£Ø®Ø±Ù‰ ===== */
.top-actions a{
    text-decoration:none;
    margin-left:8px;
    padding:8px 15px;
    background:#333;
    color:#fff;
    border-radius:8px;
}

/* ===== Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ ===== */
.welcome-msg {
    font-size:22px;
    color:#7a0000;
    font-weight:bold;
    text-align:center;
    margin-bottom:15px;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

/* ===== Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ===== */
#pdfArea {
    width: 100%;
    max-width: 600px;
    filter: blur(6px);
    pointer-events:none;
    transition:.3s;
}

#pdfArea.clear{
    filter:none;
    pointer-events:auto;
}

.user-card {
    position: relative;
    background: linear-gradient(145deg, #7a0000, #a00000);
    border-radius: 20px;
    padding: 20px;
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    box-shadow: 0 15px 30px rgba(0,0,0,.4);
    overflow: hidden;
}

.user-card::after {
    content: "";
    position: absolute;
    inset: 0;
    background: url('static/images/logo.png') no-repeat center/320px;
    opacity: 0.20;
    z-index: 0;
}

.logo-top {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 85px;
    height: 85px;
    background: url('static/images/logo.png') no-repeat center/contain;
    z-index: 3;
}

.profile-column {
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 3;
}

.profile-box {
    width: 120px;
    height: 120px;
    border: 3px solid gold;
    border-radius: 16px;
    overflow: hidden;
    background: #fff;
}

.profile-box img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.identity-logo {
    width: 46px;
    height: 46px;
    margin: 8px 0;
    background: url('static/images/logo.png') no-repeat center/contain;
}

.qr-box img {
    width: 95px;
    height: 95px;
    border: 2px solid gold;
    border-radius: 8px;
    background: #fff;
}

.user-info {
    color: #fff;
    flex: 1;
    z-index: 3;
    min-width: 180px;
}

.user-info h2 {
    margin: 0 0 8px;
    font-size: 22px;
}

.user-info p {
    margin: 3px 0;
    font-size: 14px;
}

.verify-code {
    margin-top: 8px;
    padding: 6px 10px;
    background: rgba(255,255,255,.15);
    border-radius: 8px;
    font-size: 13px;
    display: inline-block;
}

.card-features {
    background: #fff;
    border-radius: 18px;
    margin-top: 15px;
    box-shadow: 0 10px 25px rgba(0,0,0,.25);
}

.card-features h3 {
    margin: 0;
    padding: 12px;
    background: #7a0000;
    color: #fff;
    text-align: center;
}

.card-features ul {
    padding: 15px 25px;
    margin: 0;
}

.control-buttons{
    margin-top:20px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
}

.control-buttons button{
    padding:12px 20px;
    border:none;
    border-radius:10px;
    background:#7a0000;
    color:#fff;
    cursor:pointer;
    box-shadow:0 5px 15px rgba(0,0,0,.3);
}

.download-btn{
    display:none;
}

/* ===== Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ===== */
.transactions-container {
    width: 100%;
    max-width: 600px;
    margin-top: 30px;
    background: #fff;
    border-radius: 18px;
    box-shadow: 0 10px 25px rgba(0,0,0,.15);
    overflow: hidden;
}

.transactions-container h3 {
    background: #7a0000;
    color: #fff;
    margin: 0;
    padding: 12px;
    text-align: center;
}

.transactions-container table {
    width: 100%;
    border-collapse: collapse;
}

.transactions-container th, 
.transactions-container td {
    padding: 10px;
    text-align: center;
    border-bottom: 1px solid #eee;
}

.transactions-container th {
    background: #f8f8f8;
    color: #333;
    font-weight: bold;
}

.transactions-container tr:hover {
    background: #f2f2f2;
}
</style>
</head>

<body>

<!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
<div class="top-bar">

    <div class="balance-box">
        ğŸ’° Ø±ØµÙŠØ¯Ùƒ: <span id="balance">0</span> Ø¹Ù…Ù„Ø©
    </div>

    <div class="top-actions">
        <a href="/">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <a href="/logout">Ø®Ø±ÙˆØ¬</a>
    </div>

</div>

<!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ -->
<div class="welcome-msg">
    ğŸ‰ Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ {{ user.full_name }}! Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ ØªØ¬Ø±Ø¨Ø© Ø±Ø§Ø¦Ø¹Ø© ÙÙŠ Ù†Ø§Ø¯ÙŠ Ù…Ø¯ÙŠØ³ÙŠØ³Ø© ğŸ‰
</div>

<!-- Ø®Ø¯Ù…Ø§Øª Ø¬Ø°Ø§Ø¨Ø© -->
<div class="services">
    <button class="service-btn">ğŸ  Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ø³ÙƒÙ† <span>6</span></button>
    <button class="service-btn">ğŸ† Ù…Ø´Ø§Ù‡Ø¯Ø© ÙƒØ£Ø³ Ø§Ù„Ø¹Ø§Ù„Ù… <span>4</span></button>
    <button class="service-btn">ğŸ“ Ø´Ù‡Ø§Ø¯Ø© Ù…Ø¯Ø±Ø³ÙŠØ© <span>10</span></button>
</div>

<!-- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù†ÙØ³Ù‡Ø§ ÙÙ‚Ø· (Ù„ØªØ­Ù…ÙŠÙ„ PDF) -->
<div id="pdfArea">
    <div class="user-card">
        <div class="logo-top"></div>

        <div class="profile-column">
            <div class="profile-box">
                <img src="{{ user.photo_url }}">
            </div>
            <div class="identity-logo"></div>
            <div class="qr-box">
                <img src="{{ qr_code }}">
            </div>
        </div>

        <div class="user-info">
            <h2>{{ user.full_name }}</h2>
            <p>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {{ user.username }}</p>
            <p>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: {{ user.card_number }}</p>
            <p>Ø§Ù„Ù‡Ø§ØªÙ: {{ user.phone or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</p>
            <p>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ: {{ user.national_id or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</p>
            <p>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„: {{ registration_date }}</p>
            <p>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©: {{ expiry_date }}</p>
            <div class="verify-code">ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚: {{ user.card_number }}-MD</div>
        </div>
    </div>

    <div class="card-features">
        <h3>Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</h3>
        <ul>
            <li>Ø¨Ø·Ø§Ù‚Ø© Ø±Ø³Ù…ÙŠØ© Ù…Ø¹ØªÙ…Ø¯Ø©</li>
            <li>QR ØªØ­Ù‚Ù‚ Ù…Ø¨Ø§Ø´Ø±</li>
            <li>Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ Ø§Ù„ØªØ²ÙˆÙŠØ±</li>
        </ul>
    </div>
</div>

<div class="control-buttons">
    <button onclick="removeBlur()">Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙÙˆÙƒØ³ (10 Ø¹Ù…Ù„Ø§Øª)</button>
    <button class="download-btn" id="downloadBtn" onclick="downloadPDF()">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© PDF</button>
</div>

<!-- Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø· -->
<div class="transactions-container">
    <h3>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©</h3>
    <table id="transactionsTable">
        <thead>
            <tr>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th>Ø§Ù„Ø³Ø¨Ø¨</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
// Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ù…Ø¹ Ø§Ù„ØªÙƒÙ„ÙØ©
const servicesData = {
    "ğŸ  Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ø³ÙƒÙ†": 6,
    "ğŸ† Ù…Ø´Ø§Ù‡Ø¯Ø© ÙƒØ£Ø³ Ø§Ù„Ø¹Ø§Ù„Ù…": 4,
    "ğŸ“ Ø´Ù‡Ø§Ø¯Ø© Ù…Ø¯Ø±Ø³ÙŠØ©": 10
};

async function fetchUserData() {
    try {
        const res = await fetch("/user_data");
        const data = await res.json();

        document.getElementById("balance").innerText = data.balance;

        if(data.pdfCleared){
            document.getElementById("pdfArea").classList.add("clear");
            document.getElementById("downloadBtn").style.display = "inline-block";
        }

        // ØªØ¹Ø¨Ø¦Ø© Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
        if(data.transactions && data.transactions.length>0){
            const tbody = document.getElementById("transactionsTable").querySelector("tbody");
            tbody.innerHTML = "";
            data.transactions.forEach(t=>{
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${t.date_str||''}</td><td>${t.type||''}</td><td>${t.amount||''}</td><td>${t.reason||''}</td>`;
                tbody.appendChild(tr);
            });
        }

    } catch(err){
        console.error("Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", err);
    }
}

async function removeBlur(){
    try {
        const res = await fetch("/remove_focus",{method:"POST"});
        const data = await res.json();
        if(data.status==="success"){
            document.getElementById("balance").innerText=data.new_balance;
            document.getElementById("pdfArea").classList.add("clear");
            document.getElementById("downloadBtn").style.display="inline-block";
        } else {
            alert(data.msg);
        }
    } catch(err){
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");
    }
}

async function downloadPDF(){
    const { jsPDF } = window.jspdf;
    const area = document.getElementById('pdfArea');
    const rect = area.getBoundingClientRect();
    const canvas = await html2canvas(area,{scale:3,useCORS:true});
    const imgData = canvas.toDataURL('image/png',1.0);
    const pdf = new jsPDF({orientation:'landscape',unit:'px',format:[rect.width,rect.height]});
    pdf.addImage(imgData,'PNG',0,0,rect.width,rect.height);
    pdf.save('Ø¨Ø·Ø§Ù‚Ø©_Ø¹Ø¶Ùˆ_Ø±Ø³Ù…ÙŠØ©.pdf');
}

// Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø±ØµÙŠØ¯
document.addEventListener("DOMContentLoaded", () => {
    fetchUserData();

    const serviceButtons = document.querySelectorAll(".service-btn");
    serviceButtons.forEach(btn => {
        btn.addEventListener("click", async () => {
            const serviceName = btn.textContent.replace(/\d+/g,'').trim();
            const cost = servicesData[serviceName];

            if(confirm(`ğŸ”” Ù‡Ù„ ØªØ±ØºØ¨ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ${cost} Ø¹Ù…Ù„Ø© Ø±Ù‚Ù…ÙŠØ© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø®Ø¯Ù…Ø© "${serviceName}"ØŸ`)) {
                try {
                    const res = await fetch("/pay_service", {
                        method: "POST",
                        headers: {"Content-Type":"application/json"},
                        body: JSON.stringify({service: serviceName})
                    });
                    const data = await res.json();

                    if(data.status==="success"){
                        document.getElementById("balance").innerText = data.new_balance;
                        alert(`âœ… ØªÙ… Ø®ØµÙ… ${cost} Ø¹Ù…Ù„Ø© Ø±Ù‚Ù…ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ "${serviceName}"!`);
                    } else {
                        alert(`âŒ ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${data.msg}`);
                    }

                } catch(err){
                    alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
                    console.error(err);
                }
            }
        });
    });
});
</script>
</body>
</html>
